# 运行指南（后端 API）

本指南帮助你在本地快速搭建并验证整套后端能力，同时了解各模块提供的 HTTP 接口。所有示例均以 `http://127.0.0.1:8000` 为默认地址，可根据实际情况调整。

---

## 1. 前置条件

- **Python 3.10+**（建议使用 3.10 或 3.11）
- **pip**（随 Python 一同安装）
- **Windows PowerShell / macOS 终端 / Linux Shell**
- （可选）Node.js 环境，仅在你需要进一步完善前端时使用，与后端运行无直接关系

---

## 2. 环境准备

### 2.1 Windows PowerShell

```powershell
# 建议在项目根目录执行以下命令
python -m venv .venv
. .venv/Scripts/Activate.ps1
pip install -r requirements.txt

# 初始化环境变量（复制示例文件后再编辑）
Copy-Item .env.example .env
# 打开 .env，写入：
# GPT_API_KEY=<你的 OpenAI API Key>
```

### 2.2 macOS / Linux

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
# 编辑 .env 并填入 GPT_API_KEY
```

> **可选：Web Search 能力**
> - 如果你的 OpenAI 账号开通了 Web Search Tool，可在 `.env` 中启用：
>   - `OPENAI_USE_WEB_TOOL=1`
>   - `OPENAI_MODEL_WEB=gpt-5-nano-2025-08-07`（或你已授权的其它模型）
>   - `OPENAI_WEB_TOOL_TYPE=web_search_preview`
> - 未开通时请保持默认（即不设置上述变量），后端会自动回退到本地 Mock。

---

## 3. 启动后端

```powershell
uvicorn apps.api.main:app --reload --port 8000
```

- Swagger 文档地址：<http://127.0.0.1:8000/docs>
- 前端演示页：<http://127.0.0.1:8000/ui/index.html>（静态页面，无需额外构建）

---

## 4. 快速自测

以下示例基于 PowerShell；macOS/Linux 可将 `Invoke-WebRequest` 替换为 `curl`。

### 4.1 画像解析（Structured Profile）

```powershell
$body = Get-Content data/profile_sample.json -Raw
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/profile/analyze `
  -Body $body `
  -ContentType 'application/json'
```

- 返回内容包含 `profile`、`normalized_skills`、`course_skills` 等字段。
- 如需测试上传简历，可通过前端页面或直接调用 `/profile/analyze-upload`（`multipart/form-data`）。

### 4.2 职位检索（批量）

```powershell
$body = '{
  "query": {"titles":["Software Engineer"], "keywords":["Python"], "locations":["AU"]},
  "sources":["seek","linkedin"],
  "allocation": {"seek":5, "linkedin":5},
  "limit":10,
  "exclude_hashes": []
}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/jobs/search `
  -Body $body `
  -ContentType 'application/json'
```

- 若开启 `OPENAI_USE_WEB_TOOL=1` 且凭证可用，将返回真实职位列表；否则返回空数组。
- 设置 `session_id` 后可通过 `/jobs/next-batch` 获取不重复的新一批职位：

```powershell
$sid = "test-session-001"
$payload = '{
  "session_id": "' + $sid + '",
  "query": {"titles":["Software Engineer"], "keywords":["Python"], "locations":["AU"]},
  "allocation": {"seek":5, "linkedin":5},
  "limit":10
}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/jobs/next-batch `
  -Body $payload `
  -ContentType 'application/json'
```

### 4.3 职位流（SSE）

`/jobs/stream` 以 **Server Sent Events** 返回职位，适用于前端实时展示。

PowerShell 示例：

```powershell
$sid = "test-session-002"
$body = '{
  "session_id":"' + $sid + '",
  "query": {"titles":["Software Engineer"], "keywords":["Python"], "locations":["AU"]},
  "allocation": {"seek":5, "linkedin":5},
  "limit":10
}'
irm -Method POST `
  -Uri http://127.0.0.1:8000/jobs/stream `
  -Body $body `
  -ContentType 'application/json'
```

SSE 事件类型：

- `job`：单条职位数据（JSON）
- `progress`：`{ delivered, requested }` 进度
- `end`：数据流结束

GET 方式示例（可直接在浏览器控制台使用）：

```javascript
const es = new EventSource('/jobs/stream?session_id=test-session-003&titles=Software%20Engineer&keywords=Python&locations=AU&seek=5&linkedin=5&limit=10');
es.addEventListener('job', (e) => console.log('job', JSON.parse(e.data)));
es.addEventListener('progress', (e) => console.log('progress', JSON.parse(e.data)));
es.addEventListener('end', () => { console.log('end'); es.close(); });
```

### 4.4 简历预览 & 导出

```powershell
$body = '{
  "profile": {"skills":["Python","ROS"]},
  "template_id": "resume-ats-en",
  "language": "en"
}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/resume/preview `
  -Body $body `
  -ContentType 'application/json'
```

- `/resume/file/docx` 和 `/resume/file/pdf` 分别导出 Word 和 PDF：

```powershell
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/resume/file/docx `
  -Body $body `
  -ContentType 'application/json' `
  -OutFile output.docx
```

> PDF 导出依赖 Playwright（Chromium）。首次使用时需要安装：
> ```powershell
> pip install playwright
> python -m playwright install chromium
> ```
> 若未安装，将返回 503 并提示安装步骤。

### 4.5 画像润色（LLM 改写）

```powershell
$body = '{
  "profile": {"name":"Alice","skills":["Python","C++","FastAPI"],
    "experience":[{"company":"Uni Project","role":"Engineer","bullets":["Built REST APIs with FastAPI","Wrote C++ modules for robotics control"]}]},
  "jd": {"keywords":["Python","C++","FastAPI"], "requirements":["3+ years C++ product development.","Python/FastAPI for HTTP APIs."]},
  "options": {"tone":"impactful","tense":"past","max_bullets_per_role":5,"include_jd_keywords":true}
}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/resume/refine `
  -Body $body `
  -ContentType 'application/json'
```

- 需要在 `.env` 中提供可用的 `GPT_API_KEY`；若不可用，将返回原始 bullets 并附 `notes: ["llm_unavailable"]`。

---

## 5. JD 抓取与匹配

### 5.1 抓取 JD

```powershell
$body = '{"jd_url":"https://www.seek.com.au/job/123456"}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/jd/fetch `
  -Body $body `
  -ContentType 'application/json'
```

- 返回字段包括 `title`、`company`、`requirements[]`、`keywords[]` 等。
- 若遇到 403，可设置 `render: true` 使用 Playwright 渲染再解析（需要提前安装 Playwright）。

### 5.2 画像与 JD 匹配

```powershell
$profile = '{
  "name": "Alice",
  "location": "Melbourne VIC",
  "skills": ["Python", "C++", "FastAPI", "Git"],
  "courses": [{"code":"COMP9434","name":"Robotics Software Architectures","skills":["ROS","Python"],"topics":["Behavior Trees"]}],
  "experience": [
    {"company":"Uni Project","role":"Engineer","bullets":["Built REST APIs with FastAPI","Wrote C++ modules for robotics control"]}
  ]
}'

$jd = '{
  "title":"Software Engineer",
  "location":"Docklands, Melbourne VIC",
  "requirements":["Experience with Python and FastAPI","3+ years C++ product development"],
  "keywords":["Python","C++","FastAPI"]
}'

$body = '{"profile": ' + $profile + ', "jd": ' + $jd + '}'
Invoke-WebRequest -Method POST `
  -Uri http://127.0.0.1:8000/matching/match `
  -Body $body `
  -ContentType 'application/json'
```

- 返回 `score (0-100)`、`reasons[]`、`gaps[]`、`recommendations[]`。

---

## 6. 目录结构要点

- `apps/api/main.py`：FastAPI 入口，挂载所有模块路由以及前端静态文件。
- `modules/*`：按功能拆分的业务模块，例如 `profile`、`jobs`、`jd`、`matching`、`resume`。
- `templates/`：简历模板（ATS / 视觉化）。
- `data/profile_sample.json`：画像解析示例数据。
- `prompts/system_prompt.txt`：Agent 使用的系统 Prompt。

---

## 7. 前端 Demo 快速体验

1. 启动后端后，在浏览器打开 `apps/ui/index.html`（或通过 `http://127.0.0.1:8000/ui/`）。
2. 页面顶部可设置 `API Base` 和 `Session ID`，点击「测试连通性」确认后端状态。
3. **STEP 1 - 画像构建**：填写自由文本或上传简历 → 点击「调用画像 API」，右侧展示结构化画像。
4. **STEP 2 - 职位检索**：配置职位标题、关键字、地区、来源占比 → 「开始流式搜索」查看实时返回的职位卡片。
5. **STEP 3 - 匹配与简历输出**：
   - 在职位卡片中依次点击「解析 JD」「匹配」「预览」。
   - 右侧展示匹配得分与建议，可直接「导出 DOCX / PDF」。

> 如果解析 JD 返回 403，可勾选「JD 抓取失败时尝试 Playwright 渲染」以开启无头浏览器渲染（需事先安装 Playwright）。

---

## 8. 下一步建议

- 在 `modules/jobs/adapters/` 中接入更多真实招聘渠道。
- 在 `modules/jd/` 中补充完整的页面抓取与解析逻辑（当前以示例为主）。
- 为简历导出增加缓存策略与导出队列，提升高并发场景性能。
- 完善单元测试与端到端测试，确保核心流程稳定。

---

如在运行过程中遇到任何问题，可查看终端日志或通过 `uvicorn` 的 `--log-level debug` 获得更多调试信息。祝开发顺利！

